
---

### **6.1 数据链路层概述**

#### **6.1.1 数据链路层的基本概念**

**1. 核心地位**
数据链路层位于**物理层**（第1层）和**网络层**（第3层）之间。
*   **向下**：利用物理层提供的比特流传输服务。
*   **向上**：为网络层提供可靠（或尽力而为）的链路传输服务。

**2. 两个关键术语：链路 vs 数据链路**
这是本章最基础的概念区分：
*   **链路 (Link)**：一条无源的点到点的**物理线@路段**，中间没有任何其他的交换结点。
    *   *比喻*：这就好比是一条单纯的**柏油马路**。
*   **数据链路 (Data Link)**：**物理线路 + 实现通信协议的硬件和软件**。
    *   通常使用**网络适配器**（网卡，NIC）来实现这些协议。
    *   *比喻*：柏油马路（链路）+ 交通规则 + 红绿灯 + 摄像头 = **数据链路**。只有有了规则，车才能在路上有序跑起来。

**3. 传输单元：帧 (Frame)**
数据链路层的协议数据单元（PDU）叫做**帧**。
*   数据链路层把网络层交下来的数据（IP数据报）封装成**帧**，发送给物理层。

**4. 三个基本问题**
无论哪种数据链路层协议（以太网、PPP等），都要解决三个基本问题：
1.  **封装成帧**（怎么打包？）
2.  **差错控制**（传错了怎么办？）
3.  **可靠传输**（丢包了怎么办？*注：现代有线网络通常不在此层做复杂的可靠传输，交由TCP负责*）

---

#### **6.1.2 封装成帧 (Framing)**

**1. 什么是封装成帧？**
就是给网络层的IP数据报（数据部分），加上一个**首部 (Header)** 和一个**尾部 (Trailer)**。
*   **作用**：
    1.  **帧定界**：首部和尾部包含了特定的**帧定界符**，告诉接收端：哪里是帧的开始，哪里是帧的结束。
    2.  **承载控制信息**：如地址信息（MAC地址）、差错检测码（FCS）等。

**2. 最大传输单元 (MTU)**
*   **定义**：帧的**数据部分**（Payload，即IP数据报）的长度上限。
*   **限制**：这就像高速公路的限高杆。例如，以太网的MTU通常是 **1500字节**。如果IP数据报超过1500字节，网络层就必须进行**分片**（我们在上一章IP分片学过的内容）。

**3. 透明传输 (Transparency)**
这是一个非常有趣且重要的技术难点。
*   **问题**：假设帧的“结束标记”是特定的二进制序列（比如 `01111110`）。如果数据部分（Payload）里**恰好**也包含了这个序列，接收端会不会误以为帧提前结束了？
*   **目标**：**透明传输**意味着无论数据是什么样的（哪怕和控制字符长得一样），都能被正确传输，不会导致误判。
*   **解决方案**：
    *   **字节填充 (Byte Stuffing)**：
        *   用于**面向字符**的协议（如PPP）。
        *   如果在数据中出现了和“结束标记”一样的字符，发送方会在它前面插入一个**转义字符 (ESC)**。
        *   接收方读到转义字符，就知道后面那个字符是数据，不是结束标记，然后把转义字符删掉。
    *   **零比特填充 (Bit Stuffing)**：
        *   用于**面向比特**的协议（如HDLC）。
        *   **规则**：只要数据中连续出现了 **5个“1”**，发送方就立即在后面插入一个 **“0”**。
        *   **效果**：保证数据中永远不会出现连续的6个“1”（假设结束标记是 `01111110`）。接收方看到连续5个1后面有个0，直接把0删掉还原数据；如果看到连续6个1，就知道这是帧结束标记。

---

### **6.1.3 寻址 (Addressing)**

在数据链路层，我们需要一种机制来区分连接在同一个物理介质（比如同一根网线或同一个WiFi频段）上的不同设备。这就是**MAC地址**的作用。

**1. MAC地址 (Media Access Control Address)**
*   **别名**：物理地址、硬件地址。
*   **本质**：它是烧录在网络适配器（网卡）上的一个永久性标识。
*   **格式**：**48位**（6字节）的二进制数。通常用**16进制**表示，中间用冒号或减号分隔。
    *   例如：`00-16-EA-AE-3C-40`
*   **结构**：
    *   前24位：**OUI (组织唯一标识符)**，代表厂商（比如Intel, Cisco, Apple）。
    *   后24位：**扩展标识符**，由厂商自行分配给具体的网卡。
*   **特性**：
    *   **全球唯一性**：原则上，全球每一块网卡的MAC地址都是独一无二的。
    *   **扁平化**：MAC地址没有层次结构（不像IP地址有网络号、主机号），它就像身份证号，而IP地址像家庭住址。无论你带着笔记本电脑去哪里，MAC地址不变，但IP地址会变。

**2. 三种帧类型**
根据目的MAC地址的不同，帧分为三类：
1.  **单播帧 (Unicast)**：一对一。目的MAC地址是某个具体设备的地址。只有该设备会接收并处理。
2.  **广播帧 (Broadcast)**：一对全体。目的MAC地址是 **`FF-FF-FF-FF-FF-FF`**（全1）。局域网内的**所有**设备都会接收并处理。
3.  **多播帧 (Multicast)**：一对一组。目的MAC地址是特定的多播组地址。只有加入了该组的设备会接收。

---

### **6.1.4 差错控制 (Error Control)**

信号在物理线路上传输时，受噪声干扰，可能会出现**比特差错**（0变成了1，或者1变成了0）。数据链路层必须能够发现这些错误。

**1. 差错检测：循环冗余校验 (CRC)**
这是目前最常用的差错检测技术。
*   **原理**：
    1.  **发送方**：利用**CRC算法**（基于模2除法），对要发送的数据计算出一个**校验码**（余数）。
    2.  **封装**：将这个校验码填入帧尾部的 **FCS (Frame Check Sequence - 帧检验序列)** 字段中。
    3.  **接收方**：收到帧后，用相同的算法再算一遍。
        *   如果余数为0：认为传输**无差错**，接受。
        *   如果余数不为0：认为传输**有差错**，**丢弃**。

**2. 重要概念辨析：FCS vs CRC**
*   **CRC** 是一种数学**算法**（怎么算）
*   **FCS** 是帧尾部的那个**字段**（算出来的结果放哪）。
*   我们在FCS字段中放入用CRC算法计算出的检错码。

**3. “无差错接受” vs “可靠传输”**
这是一个非常容易混淆的考点，请务必注意：
*   **凡是接收端收下的帧，都是无差错的**：因为有差错的帧都在CRC校验阶段被**丢弃**了。
*   **但这不代表“可靠传输”**：
    *   **可靠传输**意味着：发送方发什么，接收方就收到什么（不丢、不重、不错）。
    *   **以太网（有线局域网）**：通常**不提供**可靠传输。如果帧错了，路由器/交换机直接丢弃，**不会**通知发送方重传。重传的工作交给上层的**TCP**去操心。
    *   **无线局域网 (WiFi)**：由于无线链路质量差，干扰大，通常会在数据链路层**实现**确认和重传机制，提供可靠传输。

---


### **6.1.5 介质访问控制 (Medium Access Control)**

这是一个非常关键的概念。想象一下，如果多台计算机连接在**同一根总线**上（比如早期的以太网），或者大家都连接在**同一个WiFi频段**里。如果两个人同时说话，信号就会叠在一起，变成乱码。这就叫**冲突 (Collision)**。

介质访问控制（MAC）子层就是负责解决这个问题的“交通规则”。主要分为两类：

#### **1. 静态划分信道 (Static Channel Partitioning)**
*   **方法**：频分复用 (FDM)、时分复用 (TDM) 等。
*   **原理**：像切蛋糕一样，把信道按频率或时间切好，每个人固定一块。
*   **缺点**：对于计算机网络这种**突发性**很强的数据流来说，效率太低（我不说话时，我的那块蛋糕就浪费了）。

#### **2. 动态媒体接入控制 (Dynamic/Random Access)**
这是计算机网络（尤其是局域网）的主流方式。核心思想是：**谁想发就发，但要遵守规则**。

最著名的协议是 **CSMA/CD**（用于有线以太网）。

*   **CSMA/CD (Carrier Sense Multiple Access with Collision Detection)**
    *   **载波监听 (CS - Carrier Sense)**：**“听”**。发送前先监听信道。如果有别人在发，我就不发，等着。
    *   **多点接入 (MA - Multiple Access)**：**“共用”**。大家都在同一条线上。
    *   **碰撞检测 (CD - Collision Detection)**：**“撞了就停”**。
        *   即使监听时信道空闲，发送出去后也可能撞车（因为信号传播需要时间）。
        *   **边发边听**：发送方在发送数据的同时，检测信道上的电压变化。
        *   一旦发现冲突，立即**停止发送**，并发送一个**干扰信号 (Jamming Signal)** 通知大家。
        *   **退避算法**：停下来后，等待一个**随机**的时间，然后再重试。

*   **比喻**：这就好比在开**圆桌会议**。
    1.  你想发言，先听听有没有人在说话（CS）。
    2.  没人说话，你开始说。
    3.  刚说两个字，发现对面小明也同时开口了（冲突）。
    4.  你们俩都立刻闭嘴（CD），各自心里默数一个随机数（退避），谁数完了谁再开口。

*   **注意**：CSMA/CD 主要用于**总线型**或**半双工**的早期以太网。现在的全双工交换式以太网（Switch）因为没有冲突，已经不再需要CSMA/CD了，但在WiFi（无线局域网）中，使用的是它的变体 **CSMA/CA**（碰撞避免），后面我们会细讲。

---

### **6.1.6 流量控制 (Flow Control)**

我们在第四章传输层（TCP）学过流量控制，这里为什么又要讲一遍？因为层次不同。

*   **传输层流量控制**：是**端到端 (End-to-End)** 的。比如你的电脑和百度的服务器之间，通过互联网协调速度。
*   **链路层流量控制**：是**点到点 (Point-to-Point)** 的。比如你的电脑和直接相连的**交换机**之间，或者路由器A和路由器B之间协调速度。

**常见机制**（原理与TCP类似，但实现层级不同）：

1.  **停止-等待协议 (Stop-and-Wait)**
    *   发一帧，等一个确认（ACK）。收到ACK再发下一帧。
    *   效率低，像挤牙膏。

2.  **滑动窗口协议 (Sliding Window)**
    *   允许连续发送多个帧（在窗口大小内）。
    *   **后退N帧 (GBN)**：如果你丢了一个帧，这就得重传这个帧以及后面所有的帧。
    *   **选择重传 (SR)**：只重传丢的那一个帧。

**现代以太网的流量控制**：
在现代的全双工以太网中，通常使用 **PAUSE帧**。当交换机缓冲区快满时，它会向你的网卡发送一个PAUSE帧，意思是：“兄弟，歇会儿，我处理不过来了”。网卡收到后会暂停发送数据一段时间。

---

