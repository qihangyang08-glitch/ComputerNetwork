### <a name="toc"></a>应用层 (Application Layer) - 知识点索引

*   [**1. 应用层协议原理**](#1-应用层协议原理)
    *   [1.1 客户-服务器方式 (C/S)](#11-客户-服务器方式-cs)
        *   `服务器 (Server)`
        *   `客户 (Client)`
        *   `C/S 架构`
    *   [1.2 对等计算模式 (P2P)](#12-对等计算模式-p2p)
        *   `对等方 (Peer)`
        *   `P2P 架构`
        *   `BitTorrent (BT)`
        *   `Tracker 服务器`
        *   `种子 (Seed)`
        *   `Peer/Leecher`
        *   `DHT (分布式哈希表)`
    *   [1.3 进程通信](#13-进程通信)
        *   `进程 (Process)`
        *   `IP 地址`
        *   `端口号 (Port Number)`
        *   `套接字 (Socket)`
        *   `服务器套接字 (Server Socket)`
*   [**2. 万维网 (World Wide Web)**](#2-万维网-world-wide-web)
    *   [2.1 万维网概述](#21-万维网概述)
        *   `万维网 (WWW)`
        *   `互联网 (Internet)`
        *   `HTML (超文本标记语言)`
        *   `超文本 (HyperText)`
        *   `超链接 (Hyperlink)`
        *   `URL (统一资源定位符)`
        *   `HTTP (超文本传输协议)`
    *   [2.2 HTTP 概述](#22-http-概述)
        *   `TCP 协议`
        *   `无状态 (Stateless)`
        *   `会话 (Session)`
        *   `请求-响应模型`
        *   `持久连接 (Persistent Connection)`
        *   `非持久连接`
        *   `流水线 (Pipelining)`
    *   [2.3 HTTP 报文格式](#23-http-报文格式)
        *   `请求报文 (Request Message)`
        *   `响应报文 (Response Message)`
        *   `起始行`
        *   `首部行`
        *   `实体主体`
        *   `请求方法 (GET, POST, HEAD)`
        *   `状态码 (200, 3xx, 404, 5xx)`
    *   [2.4 Cookie](#24-cookie)
        *   `Cookie`
        *   `Set-Cookie (响应首部)`
        *   `Cookie (请求首部)`
        *   `会话管理`
        *   `HttpOnly / Secure / SameSite`
    *   [2.5 代理服务器和 CDN](#25-代理服务器和-cdn)
        *   `代理服务器 (Proxy Server)`
        *   `原始服务器 (Origin Server)`
        *   `缓存 (Caching)`
        *   `内容分发网络 (CDN)`
        *   `边缘服务器 (Edge Server)`
        *   `延迟 (Latency)`
        *   `回源 (Cache Miss)`
    *   [2.6 HTTP/2](#26-http2)
        *   `队头阻塞 (Head-of-Line Blocking, HOLB)`
        *   `二进制分帧 (Binary Framing)`
        *   `帧 (Frame)`
        *   `消息 (Message)`
        *   `流 (Stream)`
        *   `多路复用 (Multiplexing)`
        *   `头部压缩 (HPACK)`
        *   `服务器推送 (Server Push)`
    *   [2.7 HTTP/3](#27-http3)
        *   `TCP 队头阻塞`
        *   `QUIC 协议`
        *   `UDP 协议`
        *   `0-RTT / 1-RTT`
        *   `连接迁移 (Connection Migration)`
        *   `连接 ID (Connection ID)`
*   [**3. 域名系统 (Domain Name System, DNS)**](#3-域名系统-domain-name-system-dns)
    *   [3.1 域名系统概述](#31-域名系统概述)
        *   `域名解析`
    *   [3.2 域名空间](#32-域名空间)
        *   `域名空间 (Domain Name Space)`
        *   `根 (.)`
        *   `顶级域名 (TLD)`
        *   `二级域名 (SLD)`
        *   `子域名 (Subdomain)`
        *   `完全限定域名 (FQDN)`
    *   [3.3 域名服务器和资源记录](#33-域名服务器和资源记录)
        *   `根域名服务器`
        *   `顶级域名服务器 (TLD Server)`
        *   `权威域名服务器 (Authoritative Server)`
        *   `本地域名服务器 (Local Server)`
        *   `资源记录 (Resource Record, RR)`
        *   `记录类型 (A, AAAA, NS, CNAME, MX)`
        *   `TTL (生存时间)`
    *   [3.4 域名解析过程](#34-域名解析过程)
        *   `递归查询 (Recursive Query)`
        *   `迭代查询 (Iterative Query)`
        *   `hosts 文件`
*   [**4. 动态主机配置协议 (DHCP)**](#4-动态主机配置协议-dhcp)
    *   `DHCP 服务器 / 客户端`
    *   `IP 地址池 (Address Pool)`
    *   `DORA (Discover, Offer, Request, Acknowledge)`
    *   `广播 (Broadcast)`
    *   `租期 (Lease Time)`
*   [**5. 电子邮件 (Email)**](#5-电子邮件-email)
    *   `用户代理 (User Agent, UA)`
    *   `邮件服务器 (Mail Server)`
    *   `邮箱 (Mailbox)`
    *   `SMTP (简单邮件传输协议)`
    *   `推协议 (Push Protocol)`
    *   `POP3 (邮局协议)`
    *   `IMAP (互联网邮件访问协议)`
    *   `拉协议 (Pull Protocol)`
*   [**6. 文件传输协议 (FTP)**](#6-文件传输协议-ftp)
    *   `控制连接 (Control Connection)`
    *   `数据连接 (Data Connection)`
    *   `带外控制 (Out-of-band)`
    *   `主动模式 (Active Mode)`
    *   `被动模式 (Passive Mode, PASV)`

---
---

---

### **应用层 第五部分：电子邮件 (Email)**
[返回目录](#toc)

电子邮件系统的整体架构比我们之前学的Web服务要复杂一些，因为它涉及到“发送”和“读取”两个不同的过程，并且牵涉到多个协议和服务器角色。

#### **1. 电子邮件系统的主要构成组件**

一个完整的电子邮件系统主要由三个部分组成：

1.  **用户代理 (User Agent, UA)**
    *   **是什么**: 就是我们平时用来收发邮件的**客户端软件**。
    *   **类型**:
        *   **桌面客户端**: 如 Microsoft Outlook, Mozilla Thunderbird, Foxmail。
        *   **Web客户端 (Webmail)**: 如 Gmail, Outlook.com, QQ邮箱的网页版。当你通过浏览器收发邮件时，你的浏览器就扮演了用户代理的角色。
    *   **功能**: 提供用户界面，用于撰写、显示、管理邮件，并与邮件服务器进行交互。

2.  **邮件服务器 (Mail Server)**
    *   **是什么**: 这是电子邮件系统的核心和中枢。它是一个永远在线的、功能强大的服务器程序。
    *   **核心功能**:
        *   **发送邮件**: 接收来自用户代理的待发邮件，并将其投递到目标收件人的邮件服务器。
        *   **接收邮件**: 接收来自其他邮件服务器的邮件，并将其存入相应用户的**邮箱 (Mailbox)** 中。
        *   **管理邮箱**: 每个用户在邮件服务器上都有一个专属的存储空间，即邮箱，用来存放所有发给他的邮件。
    *   **一个比喻**: 邮件服务器就像一个**邮局**。它有收件窗口（接收你要寄的信），有投递员（把信送到其他邮局），还有大量的邮政信箱（为每个居民存储收到的信件）。

3.  **相关协议 (Protocols)**
    *   电子邮件系统不是由一个协议，而是由**一组协议**协同工作的。最核心的有三个：
        *   **SMTP (Simple Mail Transfer Protocol)**: 简单邮件传输协议。
        *   **POP3 (Post Office Protocol - version 3)**: 邮局协议第3版。
        *   **IMAP (Internet Mail Access Protocol)**: 互联网邮件访问协议。

#### **2. 核心协议及其分工**

理解这三个协议的分工是理解邮件系统的关键。

**A. SMTP: 简单邮件传输协议 —— 只负责“推”送邮件**

*   **作用**: SMTP是电子邮件的“投递员”，它负责将邮件从**发送方**一路“推” (Push) 到**接收方的邮件服务器**。
*   **传输路径**:
    1.  从 **发送方的用户代理** 推送到 **发送方的邮件服务器**。
    2.  从 **发送方的邮件服务器** 推送到 **接收方的邮件服务器**。
*   **协议特征**:
    *   使用 **TCP** 提供可靠的数据传输，服务器监听 **25号端口**。
    *   是一个**推协议 (Push Protocol)**。通信总是由发送方主动发起。
    *   **只管发送，不管读取**: SMTP的任务在邮件成功进入接收方邮件服务器的邮箱后就结束了。至于收件人如何从他的邮箱里把邮件取出来，SMTP完全不关心。

**B. POP3 和 IMAP: 邮件访问协议 —— 负责“拉”取邮件**

当邮件已经安稳地躺在**接收方的邮件服务器**上时，收件人需要一种方法把邮件从服务器的邮箱里“拉” (Pull) 到自己的用户代理（电脑或手机）上来阅读。POP3和IMAP就是为此而生的。

**POP3: 邮局协议第3版**

*   **工作模式 (像邮局取信)**:
    1.  **认证**: 用户代理连接到邮件服务器（使用TCP，端口110），提供用户名和密码。
    2.  **事务**: 客户端可以列出邮件、下载邮件、删除邮件。
    3.  **更新**: 结束会话。
*   **核心特点 (“下载并删除”模式)**: 默认情况下，POP3会将服务器上的邮件**下载**到你的本地设备上，然后从服务器上**删除**这些邮件。
*   **优点**: 邮件存储在本地，可以离线阅读，不占用服务器空间。
*   **缺点**: 非常不适合多设备用户。如果你在电脑上用POP3收了邮件，服务器上的邮件就没了，你的手机上就再也看不到这些邮件了。它是一种“无状态”的协议。

**IMAP: 互联网邮件访问协议**

*   **工作模式 (像远程文件柜)**:
    1.  用户代理连接到邮件服务器（使用TCP，端口143）。
    2.  IMAP允许用户在**服务器上直接管理**邮件，而不仅仅是下载。用户可以创建文件夹、移动邮件、标记已读/未读等。
    3.  所有操作都会**同步到服务器**上。
*   **核心特点 (“远程同步”模式)**: 邮件始终保留在服务器上，用户代理只是获取一个“副本”或“视图”来进行操作。
*   **优点**: **完美支持多设备同步**。你在电脑上把一封邮件标记为已读，你的手机上也会立刻看到这个变化。所有邮件和文件夹结构在所有设备上都保持一致。
*   **缺点**: 占用服务器存储空间，离线能进行的操作有限。

#### **3. 一个完整的邮件发送与接收流程**

**场景**: Alice (`alice@gmail.com`) 给 Bob (`bob@yahoo.com`) 发送一封邮件。

1.  **撰写**: Alice在她的用户代理（比如Outlook）上写好邮件，点击“发送”。
2.  **第一段 (SMTP)**: Alice的Outlook使用 **SMTP** 协议，连接到她自己的邮件服务器 `smtp.gmail.com`，并将邮件“推”送过去。
3.  **第二段 (SMTP)**: `gmail.com` 的邮件服务器发现收件人是 `@yahoo.com`，于是它向DNS查询 `yahoo.com` 的MX记录，找到了`yahoo.com`的邮件服务器地址（比如 `mx.mail.yahoo.com`）。然后，`gmail.com` 服务器使用 **SMTP** 协议，连接到`yahoo.com`的邮件服务器，并将邮件“推”送过去。
4.  **存储**: `yahoo.com` 的邮件服务器收到邮件后，将其存入Bob的邮箱中。至此，SMTP的任务完成。
5.  **读取 (IMAP/POP3)**: Bob下班回家，打开他的用户代理（比如手机上的邮件App）。
6.  Bob的App使用 **IMAP** 或 **POP3** 协议，连接到他自己的邮件服务器 `imap.mail.yahoo.com`，提供用户名和密码。
7.  服务器验证通过后，Bob的App就可以将新邮件从服务器“拉”取下来，供Bob阅读。

---

### **应用层 第六部分：文件传输协议 (FTP) (拓展)**
[返回目录](#toc)

**FTP (File Transfer Protocol)** 是互联网上最古老、最基础的应用层协议之一，专门用于在**客户端**和**服务器**之间进行**文件传输**。尽管现在有很多更现代的文件传输方式（如HTTP下载、网盘、各种即时通讯工具），但FTP凭借其独特的工作机制，在某些特定场景下（如网站管理、批量文件传输）仍然被广泛使用。

#### **1. FTP 的核心特征：两个并行的TCP连接**

这是FTP与我们之前学过的所有协议（如HTTP, SMTP）最根本的区别。FTP在一次会话中，会使用**两个独立**的TCP连接来完成任务：

1.  **控制连接 (Control Connection)**
    *   **端口**: 服务器在 **21号端口** 上监听等待客户端的连接请求。
    *   **作用**: 这条连接是“发号施令”的通道。客户端通过这条连接，向服务器发送各种**命令**，比如请求登录 (`USER`, `PASS`)、查询目录列表 (`LIST`)、指定要上传/下载的文件 (`STOR`, `RETR`) 等。服务器也会通过这条连接返回命令的执行结果（如 "230 Login successful."）。
    *   **生命周期**: 控制连接在**整个FTP会话期间**都保持打开状态。

2.  **数据连接 (Data Connection)**
    *   **端口**: 端口号是**动态**的，不固定。
    *   **作用**: 这条连接是“搬运货物”的通道。**所有实际的文件内容**和**目录列表信息**，都通过这条专用的数据连接进行传输。
    *   **生命周期**: 数据连接是**临时的**。每当有一次文件传输或目录列表请求时，就会**新建**一个数据连接；传输完毕后，这个数据连接就会被**关闭**。如果接下来要传输另一个文件，就需要再建立一个新的数据连接。

**为什么需要两条连接？**
这种“带外控制 (Out-of-band control)”的设计，将**命令**和**数据**分离开来，带来了好处。例如，在进行一个非常大的文件传输时（数据连接很繁忙），客户端仍然可以通过不被阻塞的控制连接，向服务器发送其他命令，比如查询传输进度或中止传输。

#### **2. 数据连接的两种建立模式**

数据连接是由谁主动发起建立的？根据这个问题的答案，FTP分为两种工作模式：

**A. 主动模式 (Active Mode)**

1.  **客户端 -> 服务器 (控制连接)**: 客户端首先在21号端口上与服务器建立控制连接。
2.  **客户端 -> 服务器 (告知端口)**: 客户端通过控制连接发送一个 `PORT` 命令，命令中包含了客户端自己**用来接收数据的IP地址和端口号**（比如 `PORT 192,168,1,10,200,10`，表示 `192.168.1.10:51210`）。
3.  **服务器 -> 客户端 (建立数据连接)**: 服务器收到`PORT`命令后，会**主动地**从自己的**20号端口**出发，去连接客户端指定的那个IP和端口，从而建立数据连接。
4.  **传输**: 数据通过这条连接进行传输。

*   **问题**: 这种模式对客户端侧的**防火墙**非常不友好。因为是服务器从外部主动向客户端的一个高位端口发起连接，这个行为很容易被客户端的防火墙或NAT设备当作是恶意攻击而被拦截，导致数据连接建立失败。

**B. 被动模式 (Passive Mode / PASV)**

为了解决主动模式的问题，被动模式应运而生，这也是**目前最常用**的模式。

1.  **客户端 -> 服务器 (控制连接)**: 同样，先在21号端口建立控制连接。
2.  **客户端 -> 服务器 (请求被动模式)**: 客户端通过控制连接发送一个 `PASV` 命令。
3.  **服务器 -> 客户端 (告知端口)**: 服务器收到`PASV`命令后，会在自己的一个高位端口上**被动地**打开一个监听端口，然后通过控制连接，将这个**服务器的IP地址和端口号**告诉客户端。
4.  **客户端 -> 服务器 (建立数据连接)**: 客户端收到服务器的IP和端口后，由**客户端主动地**去连接服务器指定的那个端口，从而建立数据连接。
5.  **传输**: 数据通过这条连接进行传输。

*   **优点**: 数据连接是由客户端从内部向外部发起的，这种行为通常被防火墙认为是安全的，因此连接成功率大大提高。

#### **3. FTP 会话示例**

一个典型的FTP会话流程如下：
1.  客户端与服务器在端口21建立**控制连接**。
2.  客户端发送 `USER <username>` 命令。
3.  服务器返回 `331 Password required.`
4.  客户端发送 `PASS <password>` 命令。
5.  服务器返回 `230 Login successful.` (登录成功)
6.  客户端发送 `PASV` 命令，请求被动模式。
7.  服务器返回 `227 Entering Passive Mode (IP, port)`，告知数据连接的端口。
8.  客户端**新建**一个TCP连接，连接到服务器指定的IP和端口，**数据连接**建立。
9.  客户端通过**控制连接**发送 `LIST` 命令，请求目录列表。
10. 服务器通过**数据连接**将目录列表的内容发送过来。
11. **数据连接**关闭。
12. 客户端通过**控制连接**发送 `QUIT` 命令。
13. 服务器返回 `221 Goodbye.`，**控制连接**关闭。会话结束。

---
